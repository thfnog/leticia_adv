(function($){var _=[],L=0,IS=window.FormData,D,_fr,_fm,_send=function(){if(L)return;D=_.shift();$.filebug&&alert('_send\n['+$.type(IS)+'] IS='+IS+'\n['+$.type(D)+'] D='+D+(D?'\n['+$.type(D.e)+'] D.e='+D.e:''));if(!D)return;if(D.e.length){L=1;if(IS){var ok;$.ajax({url:D.c,data:D.d,cache:false,contentType:false,processData:false,type:'post',dataType:'json',success:function(x){ok=x.d;$.filebug&&alert('success\n['+$.type(x.d)+'] x.d='+x.d);},complete:function(x){$.filebug&&alert('complete\n['+$.type(D.d)+'] D.d='+D.d+'\n\n'+x.responseText);_fn(ok);}});}else{if(!$('#_jbr_file_frame').length){_fr=$('<iframe name="_jbr_file_frame" id="_jbr_file_frame" style="display:none;"></iframe>').load(function(){L&&_fn();});$('body').append(_fr);}
if(!$('#_jbr_file_form').length){_fm=$('<form name="_jbr_file_form" id="_jbr_file_form" target="_jbr_file_frame" enctype="multipart/form-data" method="post"></form>').hide();$('body').append(_fm);}
$.each(D.e,function(i,v){v.e.name=v.t;_fm.append(v.e);});_fm.attr({action:D.c})[0].submit();}}else _fn();},_fn=function(d){L=0;if(!D){_send();return;}
d=d||{};$.each(D.e,function(i,v,w){if(w=d[i]){v.i.value=w.id;D.b&&D.b(v,w);v.e.value='';}
if(!IS){v.e.name=v.n;$(v.i).before(v.e);}});D.a&&D.a(D.e,d);_send();};$.endfile=function(d){_fn(d);}
$.filepath='ajax/file.';$.filebug=false;$.fn.upfile=function(a,b,c,d,e){if(!c&&typeof b=='string')c=b,b=null;if(!c&&!b&&typeof a=='string')c=a,a=null;a=$.isFunction(a)&&a;b=$.isFunction(b)&&b;c=(c||$.filepath)+(IS?'json':'js');d=IS&&new IS;e=[];this.each(function(i,v,w,n,t,V){V=$(v);if(!/^input$/i.test(v.nodeName)||v.type!=='file')return;n=v.name;t='file'+e.length;V.attr('i')||V.attr('i',n);(i=V.next('input[type=hidden]')[0])&&i.name==n||V.after(i=$('<input type="hidden" name="'+n+'" value="0"/>')[0]);((w=v.files)&&w[0]&&(d&&d.append(t,w[0])||1)||v.value)&&e.push({e:v,i:i,n:n,t:t});});_.push({a:a,b:b,c:c,d:d,e:e});_send();}})(jQuery);